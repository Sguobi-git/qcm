<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QCM M√©dical</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 700px;
            margin: 0 auto;
        }
        
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .timer {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 18px;
            font-weight: bold;
        }
        
        .progress-bar {
            height: 6px;
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 15px;
        }
        
        .progress-fill {
            height: 100%;
            background: white;
            transition: width 0.3s;
        }
        
        .upload-zone {
            padding: 40px;
            text-align: center;
        }
        
        .upload-box {
            border: 3px dashed #667eea;
            padding: 30px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
        }
        
        .upload-box:hover {
            background: #f7f9ff;
            border-color: #764ba2;
        }
        
        .upload-box h3 {
            color: #667eea;
            margin-bottom: 8px;
            font-size: 16px;
        }
        
        .upload-box p {
            color: #666;
            font-size: 14px;
        }
        
        .file-status {
            padding: 12px;
            background: #e8f5e9;
            border-radius: 8px;
            margin-top: 10px;
            color: #2e7d32;
            font-size: 14px;
        }
        
        .content {
            padding: 30px;
        }
        
        .question-header {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        
        .question-text {
            font-size: 16px;
            margin-bottom: 20px;
            color: #555;
            line-height: 1.5;
        }
        
        .option {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: start;
            gap: 12px;
        }
        
        .option:hover {
            border-color: #667eea;
            background: #f7f9ff;
        }
        
        .option.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .option.correct {
            border-color: #10b981;
            background: #d1fae5;
        }
        
        .option.incorrect {
            border-color: #ef4444;
            background: #fee2e2;
        }
        
        .checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid #999;
            border-radius: 4px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .option.selected .checkbox {
            background: #667eea;
            border-color: #667eea;
        }
        
        .option.correct .checkbox {
            background: #10b981;
            border-color: #10b981;
        }
        
        .option.incorrect .checkbox {
            background: #ef4444;
            border-color: #ef4444;
        }
        
        .checkbox::after {
            content: '‚úì';
            color: white;
            font-weight: bold;
            display: none;
        }
        
        .option.selected .checkbox::after,
        .option.correct .checkbox::after,
        .option.incorrect .checkbox::after {
            display: block;
        }
        
        .explanation {
            margin-top: 10px;
            padding: 12px;
            background: #fff;
            border-radius: 8px;
            color: #555;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .button {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .button-primary {
            background: #667eea;
            color: white;
        }
        
        .button-primary:hover:not(:disabled) {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .button-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .button-success {
            background: #10b981;
            color: white;
        }
        
        .button-success:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }
        
        .summary {
            text-align: center;
            padding: 40px 30px;
        }
        
        .summary h2 {
            font-size: 28px;
            color: #333;
            margin-bottom: 30px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            padding: 20px;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .info-box {
            background: #f0f4ff;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            text-align: left;
        }
        
        .info-box h3 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .info-box ol {
            margin-left: 20px;
            color: #555;
            line-height: 1.8;
        }
        
        .hidden {
            display: none;
        }

        .start-button {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div id="uploadScreen">
                <div class="header">
                    <h1>QCM M√©dical</h1>
                    <p>Entra√Ænement interactif</p>
                </div>
                <div class="upload-zone">
                    <div class="upload-box" onclick="document.getElementById('questionsFile').click()">
                        <h3>üìÑ Fichier des Questions (ENONCE)</h3>
                        <p>Cliquez pour s√©lectionner</p>
                        <input type="file" id="questionsFile" accept=".txt" style="display:none">
                    </div>
                    <div id="questionsStatus" class="file-status hidden"></div>
                    
                    <div class="upload-box" onclick="document.getElementById('answersFile').click()">
                        <h3>‚úÖ Fichier des R√©ponses (CORRIGE)</h3>
                        <p>Cliquez pour s√©lectionner</p>
                        <input type="file" id="answersFile" accept=".txt" style="display:none">
                    </div>
                    <div id="answersStatus" class="file-status hidden"></div>

                    <button id="startButton" class="button button-primary start-button hidden" onclick="startQuiz()">
                        Commencer le QCM
                    </button>
                </div>
                <div class="info-box" style="margin: 20px;">
                    <h3>Comment pr√©parer vos fichiers :</h3>
                    <ol>
                        <li>Ouvrez vos PDFs dans Google Docs</li>
                        <li>T√©l√©chargez chacun en format Texte (.txt)</li>
                        <li>Importez les deux fichiers ici</li>
                    </ol>
                </div>
            </div>
            
            <div id="quizScreen" class="hidden">
                <div class="header">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div class="timer">‚è±Ô∏è <span id="timer">0:00</span></div>
                        <div id="questionCounter" style="font-size: 14px;">Question 1 / 1</div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressBar"></div>
                    </div>
                </div>
                
                <div class="content">
                    <div class="question-header" id="questionHeader"></div>
                    <div class="question-text" id="questionText"></div>
                    <div id="optionsContainer"></div>
                    <button id="actionButton" class="button button-primary" onclick="handleAction()">Valider</button>
                </div>
            </div>
            
            <div id="summaryScreen" class="hidden">
                <div class="summary">
                    <h2>üìä R√©sum√© de la session</h2>
                    <div class="stats">
                        <div class="stat-card">
                            <div class="stat-value" id="scoreValue">0/0</div>
                            <div class="stat-label">Questions correctes</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="percentValue">0%</div>
                            <div class="stat-label">Score</div>
                        </div>
                    </div>
                    <div class="stat-card" style="margin-bottom: 20px;">
                        <div class="stat-value" id="timeValue">0:00</div>
                        <div class="stat-label">Temps total</div>
                    </div>
                    <button class="button button-primary" onclick="reset()">üîÑ Nouvelle session</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let questionsData = null;
        let answersData = null;
        let questions = [];
        let currentIndex = 0;
        let selectedAnswers = [];
        let showingCorrection = false;
        let activeTime = 0;
        let timerInterval = null;
        let results = [];

        document.getElementById('questionsFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                questionsData = event.target.result;
                document.getElementById('questionsStatus').textContent = '‚úì Questions charg√©es: ' + file.name;
                document.getElementById('questionsStatus').classList.remove('hidden');
                checkBothFilesLoaded();
            };
            reader.readAsText(file);
        });

        document.getElementById('answersFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                answersData = event.target.result;
                document.getElementById('answersStatus').textContent = '‚úì R√©ponses charg√©es: ' + file.name;
                document.getElementById('answersStatus').classList.remove('hidden');
                checkBothFilesLoaded();
            };
            reader.readAsText(file);
        });

        function checkBothFilesLoaded() {
            if (questionsData && answersData) {
                document.getElementById('startButton').classList.remove('hidden');
            }
        }

        function parseQuestions(text) {
            const questionBlocks = text.split(/Question\s+n?¬∞?\s*\d+\s*:/i).filter(b => b.trim());
            const parsed = [];

            questionBlocks.forEach((block, idx) => {
                const lines = block.split('\n').filter(l => l.trim());
                
                // Extract question text
                let questionText = '';
                const ennonceMatch = block.match(/Enonc√©\s*:\s*(.+?)(?=\n\s*[a-e]\.|$)/is);
                if (ennonceMatch) {
                    questionText = ennonceMatch[1].trim();
                }

                // Extract options
                const options = [];
                const optionRegex = /([a-e])\.\s*(.+?)(?=\n\s*[a-e]\.|$)/gis;
                let match;
                while ((match = optionRegex.exec(block)) !== null) {
                    options.push({
                        letter: match[1].toLowerCase(),
                        text: match[2].trim().replace(/\s+/g, ' ')
                    });
                }

                if (options.length > 0) {
                    parsed.push({
                        number: idx + 1,
                        text: questionText,
                        options: options
                    });
                }
            });

            return parsed;
        }

        function parseAnswers(text) {
            const questionBlocks = text.split(/Question\s+n?¬∞?\s*\d+\s*:/i).filter(b => b.trim());
            const parsed = [];

            questionBlocks.forEach((block, idx) => {
                const lines = block.split('\n').filter(l => l.trim());
                const answers = [];
                let currentAnswer = null;

                lines.forEach(line => {
                    const optionMatch = line.match(/^([A-E])\.\s*(VRAI|FAUX|Vrai|Faux)/i);
                    if (optionMatch) {
                        if (currentAnswer) answers.push(currentAnswer);
                        currentAnswer = {
                            letter: optionMatch[1].toLowerCase(),
                            isCorrect: optionMatch[2].toUpperCase() === 'VRAI',
                            explanation: line.substring(optionMatch[0].length).trim().replace(/^[.:]\s*/, '')
                        };
                    } else if (currentAnswer && line.trim()) {
                        currentAnswer.explanation += ' ' + line.trim();
                    }
                });
                if (currentAnswer) answers.push(currentAnswer);

                // Handle single answer format
                const singleAnswerMatch = block.match(/R√©ponse\s+VRAIE?\s*:\s*([A-E])/i);
                if (singleAnswerMatch && answers.length === 0) {
                    ['a', 'b', 'c', 'd', 'e'].forEach(letter => {
                        answers.push({
                            letter: letter,
                            isCorrect: letter === singleAnswerMatch[1].toLowerCase(),
                            explanation: letter === singleAnswerMatch[1].toLowerCase()
                                ? block.split('\n').slice(1).join(' ').trim()
                                : ''
                        });
                    });
                }

                parsed.push({
                    number: idx + 1,
                    answers: answers
                });
            });

            return parsed;
        }

        function mergeQuestionsAndAnswers(questionsArr, answersArr) {
            const merged = [];
            
            for (let i = 0; i < Math.min(questionsArr.length, answersArr.length); i++) {
                const q = questionsArr[i];
                const a = answersArr[i];
                
                const options = q.options.map(opt => {
                    const answerData = a.answers.find(ans => ans.letter === opt.letter);
                    return {
                        letter: opt.letter.toUpperCase(),
                        text: opt.text,
                        isCorrect: answerData ? answerData.isCorrect : false,
                        explanation: answerData ? answerData.explanation : ''
                    };
                });

                merged.push({
                    number: q.number,
                    text: q.text,
                    options: options
                });
            }

            return merged;
        }

        function startQuiz() {
            const questionsArr = parseQuestions(questionsData);
            const answersArr = parseAnswers(answersData);
            questions = mergeQuestionsAndAnswers(questionsArr, answersArr);

            if (questions.length === 0) {
                alert('Erreur lors du traitement des fichiers');
                return;
            }

            document.getElementById('uploadScreen').classList.add('hidden');
            document.getElementById('quizScreen').classList.remove('hidden');
            currentIndex = 0;
            selectedAnswers = [];
            showingCorrection = false;
            activeTime = 0;
            results = [];
            startTimer();
            displayQuestion();
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                if (!showingCorrection) {
                    activeTime++;
                    updateTimerDisplay();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const mins = Math.floor(activeTime / 60);
            const secs = activeTime % 60;
            document.getElementById('timer').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function displayQuestion() {
            const q = questions[currentIndex];
            document.getElementById('questionHeader').textContent = `Question ${q.number}`;
            document.getElementById('questionText').textContent = q.text;
            document.getElementById('questionCounter').textContent = `Question ${currentIndex + 1} / ${questions.length}`;
            
            const progress = ((currentIndex + 1) / questions.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';

            const container = document.getElementById('optionsContainer');
            container.innerHTML = '';

            q.options.forEach(opt => {
                const div = document.createElement('div');
                div.className = 'option';
                div.innerHTML = `
                    <div class="checkbox"></div>
                    <div style="flex: 1;">
                        <div><strong>${opt.letter}.</strong> ${opt.text}</div>
                        <div class="explanation hidden" id="exp-${opt.letter}"></div>
                    </div>
                `;
                div.onclick = () => toggleAnswer(opt.letter);
                div.id = `option-${opt.letter}`;
                container.appendChild(div);
            });

            const btn = document.getElementById('actionButton');
            btn.textContent = 'Valider';
            btn.className = 'button button-primary';
            btn.disabled = true;
        }

        function toggleAnswer(letter) {
            if (showingCorrection) return;

            const idx = selectedAnswers.indexOf(letter);
            if (idx > -1) {
                selectedAnswers.splice(idx, 1);
            } else {
                selectedAnswers.push(letter);
            }

            document.getElementById(`option-${letter}`).classList.toggle('selected');
            document.getElementById('actionButton').disabled = selectedAnswers.length === 0;
        }

        function handleAction() {
            if (!showingCorrection) {
                validate();
            } else {
                nextQuestion();
            }
        }

        function validate() {
            showingCorrection = true;
            const q = questions[currentIndex];
            const correctAnswers = q.options.filter(o => o.isCorrect).map(o => o.letter);
            
            const isCorrect = selectedAnswers.length === correctAnswers.length &&
                            selectedAnswers.every(a => correctAnswers.includes(a));

            results.push({
                questionNumber: q.number,
                correct: isCorrect
            });

            q.options.forEach(opt => {
                const optDiv = document.getElementById(`option-${opt.letter}`);
                const expDiv = document.getElementById(`exp-${opt.letter}`);
                
                optDiv.classList.remove('selected');
                
                if (opt.isCorrect) {
                    optDiv.classList.add('correct');
                } else if (selectedAnswers.includes(opt.letter)) {
                    optDiv.classList.add('incorrect');
                }

                if (opt.explanation) {
                    expDiv.textContent = opt.explanation;
                    expDiv.classList.remove('hidden');
                }
            });

            const btn = document.getElementById('actionButton');
            btn.textContent = currentIndex < questions.length - 1 ? 'Question suivante ‚Üí' : 'Voir le r√©sum√©';
            btn.className = 'button button-success';
            btn.disabled = false;
        }

        function nextQuestion() {
            if (currentIndex < questions.length - 1) {
                currentIndex++;
                selectedAnswers = [];
                showingCorrection = false;
                displayQuestion();
            } else {
                showSummary();
            }
        }

        function showSummary() {
            clearInterval(timerInterval);
            document.getElementById('quizScreen').classList.add('hidden');
            document.getElementById('summaryScreen').classList.remove('hidden');

            const score = results.filter(r => r.correct).length;
            const total = results.length;
            const percentage = Math.round((score / total) * 100);

            document.getElementById('scoreValue').textContent = `${score}/${total}`;
            document.getElementById('percentValue').textContent = `${percentage}%`;
            
            const mins = Math.floor(activeTime / 60);
            const secs = activeTime % 60;
            document.getElementById('timeValue').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function reset() {
            document.getElementById('summaryScreen').classList.add('hidden');
            document.getElementById('uploadScreen').classList.remove('hidden');
            questionsData = null;
            answersData = null;
            questions = [];
            document.getElementById('questionsFile').value = '';
            document.getElementById('answersFile').value = '';
            document.getElementById('questionsStatus').classList.add('hidden');
            document.getElementById('answersStatus').classList.add('hidden');
            document.getElementById('startButton').classList.add('hidden');
        }
    </script>
</body>
</html>
